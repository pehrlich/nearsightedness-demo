<!--
	Shim for Spherical Cursor Project
	Based on Three.js Pointer Lock Controls
	http://threejs.org/examples/misc_controls_pointerlock.html
-->
<!DOCTYPE html>
<html lang="en">
<head>
	<title>Threejs Cursor Project</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/84/three.js"></script>
	<script src="https://threejs.org/examples/js/loaders/MTLLoader.js"></script>
	<script src="https://threejs.org/examples/js/loaders/OBJLoader.js"> </script>
	<script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
	<script src="SphericalCursor.js"> </script>
	<style>

		html, body {
			width: 100%;
			height: 100%;
		}

		body {
			background-color: #ffffff;
			margin: 0;
			overflow: hidden;
			font-family: arial;
		}

		#blocker {

			position: absolute;

			width: 100%;
			height: 100%;

			background-color: rgba(0,0,0,0.5);

		}

		#instructions {

			width: 100%;
			height: 100%;

			display: -webkit-box;
			display: -moz-box;
			display: box;

			-webkit-box-orient: horizontal;
			-moz-box-orient: horizontal;
			box-orient: horizontal;

			-webkit-box-pack: center;
			-moz-box-pack: center;
			box-pack: center;

			-webkit-box-align: center;
			-moz-box-align: center;
			box-align: center;

			color: #ffffff;
			text-align: center;

			cursor: pointer;

		}
	

	</style>
</head>
<body>
	<div id="blocker">

		<div id="instructions">
			<span style="font-size:40px">Click to begin</span>
			<br />
			( ESC to exit )
		</div>

	</div>
</body>
<script>

// Globals 
var mtlLoader, camera, renderer, scene, objLoader = new THREE.OBJLoader;
var cursor, controls, magnifier;

var debugControls = false;

// RTT
var rtTexture, cameraRTT;

// furniture in the scene
var modelInfo = [ 
{ name: "torchere_1",     position: [ 6.8, 0, 6.2 ],     scale: 1.0  },
{ name: "vase_1",         position: [ 12.9, 0.4, 12.5 ], scale: 2.25 },
{ name: "vase_4",         position: [ 8.65, 0.15, 16 ],  scale: 2.25 },
{ name: "coffee_table_3", position: [ -6.2, 0, 0.8 ],    scale: 1.68 },
{ name: "chair_4",        position: [ -0.9, 0, 0 ],      scale: 1.2  },
//{ name: "chair_4",        position: [0, 0, 0 ],      scale: 1 }//,
{ name: "sofa_2",         position: [ -0.5, 0, 0 ],      scale: 1.2 }
];
var modelsToLoad = modelInfo.length;

function main() {

	requestPointerLock();
	initScene();
	loadModels();

}


function loadModels() {

	mtlLoader = new THREE.MTLLoader();
	var furnitureGroup = new THREE.Object3D();
	furnitureGroup.name = "furnitureGroup";

	for ( var i=0; i < modelInfo.length; i++ ) {

		loadModel( modelInfo[i], furnitureGroup );

	}

	cursor.addObject(furnitureGroup);

}


function onLoadingDone() {

	console.log("Done loading models");
	animate();

}


function loadModel(modelInfo, group) {

	var name = modelInfo.name;
	var position = (new THREE.Vector3()).fromArray(modelInfo.position);

	var dir = "./Assets/BigFurniturePack/Demo_scene/models/";
	var filename = name + ".obj";
	console.log("Loading " + filename);

	mtlLoader.setPath(dir);
	objLoader.setPath(dir);

	mtlLoader.load(filename + ".mtl", function (materials) {

		materials.preload();

		objLoader.setMaterials(materials);
		objLoader.load(filename, function (object) {

			object.name = name;
			object.scale.multiplyScalar(modelInfo.scale);
			object.position.copy(position);
			object.rotation.y = Math.PI;

			group.add(object);
			modelsToLoad--;

			if (modelsToLoad === 0) {
				scene.add(group);
				onLoadingDone();
			}

		});

	});

}



function initScene( ) {

	// scene
	scene = new THREE.Scene();

	// camera
	var aspect = window.innerWidth / window.innerHeight;
	camera = new THREE.PerspectiveCamera( 45, aspect, 1, 1000 );
	camera.position.set(0,1.8,5.0);
	camera.name = "camera";
	scene.add( camera );

	// render
	renderer = new THREE.WebGLRenderer();
	renderer.setSize( window.innerWidth, window.innerHeight );
	document.body.appendChild( renderer.domElement );

	// lights
	var ambientLight = new THREE.AmbientLight( 0x404040 ); // soft white
	ambientLight.name = "ambientLight";
	scene.add(ambientLight);
	var intensity = 1.0;
	var distance = 0;
	var pointLight = new THREE.PointLight( 0xffffff, intensity, distance );
	pointLight.name = "pointLight";
	pointLight.position.set( 1.8, 1.0, 0 );
	scene.add( pointLight );

	// floor
	var floorTexture = THREE.ImageUtils.loadTexture( "Assets/Textures/wood1.jpg" );
	floorTexture.wrapS = floorTexture.wrapT = THREE.RepeatWrapping;
	floorTexture.repeat.set( 15, 15 );

	var floor = new THREE.Mesh(
		new THREE.BoxGeometry( 50, 0, 50 ),
		new THREE.MeshBasicMaterial( { map: floorTexture } )
	);
	floor.position.y = -0.01;
	floor.name = "floor";
	scene.add( floor );

	// ceiling
	var ceiling = new THREE.Mesh(
		new THREE.BoxGeometry( 50, 0.01, 50 ),
		new THREE.MeshPhongMaterial( { color: "#FFFFFF" } )
	);
	ceiling.position.y = 3.5;
	ceiling.name = "ceiling";
//	scene.add ( ceiling );

	// cursor:
	cursor = new SphericalCursor(camera, scene);
	// So cursor appears on top
	floor.renderOrder = 0;
	ceiling.renderOrder = 0;
	cursor.mesh.renderOrder = 1;



	rtTexture = new THREE.WebGLRenderTarget(
			256, 256, {
				minFilter: THREE.LinearFilter,
				magFilter: THREE.NearestFilter,
				format: THREE.RGBFormat
			} );

	var planeMaterial = new THREE.MeshBasicMaterial({ map: rtTexture });


	var magnifier = new THREE.Mesh( new THREE.PlaneGeometry(1,1), planeMaterial);
	magnifier.position.set(0,0,0);

	cameraRTT = new THREE.PerspectiveCamera( 45, aspect, 1, 1000 );
	cameraRTT.position.set(0,1.8,5.0);
	cameraRTT.name = "cameraRTT";
	cameraRTT.zoom = 3;
	cameraRTT.updateProjectionMatrix();
	magnifier.add( cameraRTT );

	magnifier.visible = true;


	cursor.mesh.add(magnifier);


	if (debugControls) controls = new THREE.OrbitControls(camera, renderer.domElement);


}


function requestPointerLock() {

	// http://www.html5rocks.com/en/tutorials/pointerlock/intro/

	var blocker = document.getElementById( 'blocker' );
	if (debugControls) blocker.style.display = 'none';
	var instructions = document.getElementById( 'instructions' );

	var havePointerLock = 'pointerLockElement' in document || 'mozPointerLockElement' in document || 'webkitPointerLockElement' in document;

	if ( havePointerLock ) {

		var element = document.body;

		var pointerlockchange = function ( event ) {

			if ( document.pointerLockElement === element || document.mozPointerLockElement === element || document.webkitPointerLockElement === element ) {

				blocker.style.display = 'none';

			} else {

				blocker.style.display = '-webkit-box';
				blocker.style.display = '-moz-box';
				blocker.style.display = 'box';

				instructions.style.display = '';

			}

		}

		var pointerlockerror = function ( event ) {

			instructions.style.display = '';

		}

		// Hook pointer lock state change events
		document.addEventListener( 'pointerlockchange', pointerlockchange, false );
		document.addEventListener( 'mozpointerlockchange', pointerlockchange, false );
		document.addEventListener( 'webkitpointerlockchange', pointerlockchange, false );

		document.addEventListener( 'pointerlockerror', pointerlockerror, false );
		document.addEventListener( 'mozpointerlockerror', pointerlockerror, false );
		document.addEventListener( 'webkitpointerlockerror', pointerlockerror, false );

		instructions.addEventListener( 'click', function ( event ) {

			instructions.style.display = 'none';

			// Ask the browser to lock the pointer
			element.requestPointerLock = element.requestPointerLock || element.mozRequestPointerLock || element.webkitRequestPointerLock;

			if ( /Firefox/i.test( navigator.userAgent ) ) {

				var fullscreenchange = function ( event ) {

					if ( document.fullscreenElement === element || document.mozFullscreenElement === element || document.mozFullScreenElement === element ) {

						document.removeEventListener( 'fullscreenchange', fullscreenchange );
						document.removeEventListener( 'mozfullscreenchange', fullscreenchange );

						element.requestPointerLock();
					}

				}

				document.addEventListener( 'fullscreenchange', fullscreenchange, false );
				document.addEventListener( 'mozfullscreenchange', fullscreenchange, false );

				element.requestFullscreen = element.requestFullscreen || element.mozRequestFullscreen || element.mozRequestFullScreen || element.webkitRequestFullscreen;

				element.requestFullscreen();

			} else {

				if (!debugControls) element.requestPointerLock();

			}

			cursor.activate();

		}, false );

	} else {

		instructions.innerHTML = 'Your browser doesn\'t seem to support Pointer Lock API';

	}

} // end requestPointerLock


function onResize( event ) {

	camera.aspect = window.innerWidth / window.innerHeight;
	camera.updateProjectionMatrix();
	renderer.setSize( window.innerWidth, window.innerHeight );

}

function animate() {

	window.requestAnimationFrame( animate );


	if (debugControls){
		controls.update();
	}else {
		cursor.update();
	}

	renderer.render(scene, cameraRTT, rtTexture, true);
  renderer.render(scene, camera);

}

window.addEventListener( "resize", onResize, false );
window.addEventListener( "DOMContentLoaded", main, false );

</script>
</html>
